name: CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:buildx-stable-1

      - name: Create environment file
        run: |
          echo "Creating .env file for API service..."
          cat > app/.env << EOF
          # CI/CD Environment Configuration
          ORACLE_PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
          RPC_URL=http://blockchain:8545
          EVENT_MANAGER_ADDRESS=0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
          RESALE_MARKET_ADDRESS=0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
          LOYALTY_POINT_ADDRESS=0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9
          LOYALTY_SYSTEM_ADDRESS=0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9
          TICKET_NFT_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3
          REDIS_URL=redis://redis:6379
          SECRET_KEY=github-actions-test-key
          DATABASE_URL=postgresql://ticketchain:password123@postgres:5432/ticketchain
          EOF
          echo "Environment file created successfully"

      - name: Build Docker images
        run: |
          echo "Building Docker Compose services with layer caching..."
          export DOCKER_BUILDKIT=1
          export COMPOSE_DOCKER_CLI_BUILD=1

          # Build all services
          docker compose build --parallel --build-arg BUILDKIT_INLINE_CACHE=1

          echo "=== Docker system usage after build ==="
          docker system df

      - name: Save Docker images
        run: |
          echo "Saving Docker images for test job..."

          # List all images to see what was actually built
          echo "=== Available Docker images ==="
          docker images

          # Get the actual image names created by docker compose
          PROJECT_NAME=$(basename $(pwd) | tr '[:upper:]' '[:lower:]')
          echo "Project name: $PROJECT_NAME"

          # Check if images exist before saving
          if docker images --format "table {{.Repository}}:{{.Tag}}" | grep -q "${PROJECT_NAME}-api:latest"; then
            echo "Found API image: ${PROJECT_NAME}-api:latest"
          else
            echo "‚ö†Ô∏è  API image not found, checking for ticketchain-api:latest"
            if docker images --format "table {{.Repository}}:{{.Tag}}" | grep -q "ticketchain-api:latest"; then
              PROJECT_NAME="ticketchain"
            fi
          fi

          # Save the built images (only the ones that were actually built)
          docker save -o /tmp/ticketchain-images.tar \
            ${PROJECT_NAME}-api:latest \
            ${PROJECT_NAME}-blockchain:latest

      - name: Upload Docker images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: /tmp/ticketchain-images.tar
          retention-days: 1

  test:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        test-suite:
          - auth-rbac
          - event-mgr
          - loyalty-system
          - resale-market
          - marketplace-system
          - ticket-system
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download Docker images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: /tmp

      - name: Load Docker images
        run: |
          echo "Loading Docker images..."
          docker load -i /tmp/ticketchain-images.tar

      - name: Create environment file
        run: |
          echo "Creating .env file for API service..."
          cat > app/.env << EOF
          # CI/CD Environment Configuration
          ORACLE_PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
          RPC_URL=http://blockchain:8545
          EVENT_MANAGER_ADDRESS=0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
          RESALE_MARKET_ADDRESS=0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
          LOYALTY_POINT_ADDRESS=0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9
          LOYALTY_SYSTEM_ADDRESS=0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9
          TICKET_NFT_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3
          REDIS_URL=redis://redis:6379
          SECRET_KEY=github-actions-test-key
          DATABASE_URL=postgresql://ticketchain:password123@postgres:5432/ticketchain
          EOF

      - name: Start services
        run: |
          echo "Starting services for testing..."
          docker compose up --detach

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          # Wait for blockchain to be healthy
          timeout 180s bash -c 'until docker compose ps blockchain | grep -q "healthy"; do echo "Waiting for blockchain..."; sleep 5; done'

          # Wait for API to respond
          timeout 60s bash -c 'until curl -f http://localhost:8000/; do echo "Waiting for API..."; sleep 2; done'

          echo "All services are ready!"

      - name: Check service status
        run: |
          echo "=== Docker Compose Status ==="
          docker compose ps

          echo "=== API Health Check ==="
          curl -f http://localhost:8000/

          echo "=== Blockchain RPC Check ==="
          curl -f http://localhost:8545 -X POST -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'

      - name: Run Authentication & RBAC Setup
        if: matrix.test-suite == 'auth-rbac'
        run: |
          echo "=== Setting up Authentication & RBAC ==="

          # Install jq for JSON processing
          sudo apt-get update && sudo apt-get install -y jq

          # Test 1: Register users
          echo "Registering test users..."

          USER_RESPONSE=$(curl -s -X POST "http://localhost:8000/auth/register" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "testuser",
              "email": "test@example.com",
              "password": "password123",
              "full_name": "Test User",
              "wallet_address": "0x90F79bf6EB2c4f870365E785982E1f101E93b906",
              "private_key": "0x7c852118294e51e653712a81e05800f419141751be58f605c371e15141b007a6"
            }')

          USER_TOKEN=$(echo "$USER_RESPONSE" | jq -r '.access_token // empty')

          if [ -n "$USER_TOKEN" ] && [ "$USER_TOKEN" != "null" ]; then
            echo "‚úÖ User registration successful"
            echo "USER_TOKEN=$USER_TOKEN" >> $GITHUB_ENV
          else
            echo "‚ùå User registration failed"
            exit 1
          fi

          # Test 2: Login with admin user (created automatically)
          echo "Testing admin login..."
          ADMIN_RESPONSE=$(curl -s -X POST "http://localhost:8000/auth/login" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "admin",
              "password": "password123"
            }')

          ADMIN_TOKEN=$(echo "$ADMIN_RESPONSE" | jq -r '.access_token // empty')

          if [ -n "$ADMIN_TOKEN" ] && [ "$ADMIN_TOKEN" != "null" ]; then
            echo "‚úÖ Admin login successful"
            echo "ADMIN_TOKEN=$ADMIN_TOKEN" >> $GITHUB_ENV
          else
            echo "‚ùå Admin login failed"
            exit 1
          fi

          # Test 3: Test role assignment and protection
          echo "Testing role assignment..."

          # Assign organiser role to user
          ROLE_RESPONSE=$(curl -s -X POST "http://localhost:8000/auth/assign-roles" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ADMIN_TOKEN" \
            -d '{
              "username": "testuser",
              "roles": ["user", "organiser"]
            }')

          if echo "$ROLE_RESPONSE" | grep -q '"message"' && echo "$ROLE_RESPONSE" | grep -q "Successfully assigned"; then
            echo "‚úÖ Role assignment successful"
          else
            echo "‚ùå Role assignment failed"
            exit 1
          fi

          # Test role-based access control - user with organiser role should succeed
          echo "Testing organiser can create events..."

          # Login again to get updated token with new roles
          echo "Re-authenticating user to get token with updated roles..."
          USER_REAUTH_RESPONSE=$(curl -s -X POST "http://localhost:8000/auth/login" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "testuser",
              "password": "password123"
            }')

          USER_NEW_TOKEN=$(echo "$USER_REAUTH_RESPONSE" | jq -r '.access_token // empty')

          if [ -n "$USER_NEW_TOKEN" ] && [ "$USER_NEW_TOKEN" != "null" ]; then
            echo "‚úÖ User re-authentication successful"
          else
            echo "‚ùå User re-authentication failed"
            exit 1
          fi

          CREATE_SUCCESS_RESPONSE=$(curl -s -X POST "http://localhost:8000/events/create" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $USER_NEW_TOKEN" \
            -d '{
              "name": "Organiser Event",
              "venue": "Test Venue",
              "date": 1855542728,
              "price": 1000000000000000000,
              "total_tickets": 10
            }')

          echo "Create event response: $CREATE_SUCCESS_RESPONSE"

          if echo "$CREATE_SUCCESS_RESPONSE" | grep -q '"success":true'; then
            echo "‚úÖ Organiser can create events"
          else
            echo "‚ùå Organiser cannot create events"
            echo "Response details: $CREATE_SUCCESS_RESPONSE"
            exit 1
          fi

          # Test 4: Test profile endpoint
          echo "Testing profile endpoint..."
          PROFILE_RESPONSE=$(curl -s -X GET "http://localhost:8000/auth/profile" \
            -H "Authorization: Bearer $ADMIN_TOKEN")

          if echo "$PROFILE_RESPONSE" | grep -q '"username"' && echo "$PROFILE_RESPONSE" | grep -q '"roles"'; then
            echo "‚úÖ Profile endpoint working"
          else
            echo "‚ùå Profile endpoint failed"
            exit 1
          fi

          echo "=== Authentication setup completed successfully ==="

      - name: Setup Authentication for Event Tests
        if: matrix.test-suite == 'event-mgr'
        run: |
          echo "=== Setting up Authentication for Event Tests ==="

          # Install jq for JSON processing
          sudo apt-get update && sudo apt-get install -y jq

          # Get admin token for admin operations
          ADMIN_RESPONSE=$(curl -s -X POST "http://localhost:8000/auth/login" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "admin",
              "password": "password123"
            }')

          ADMIN_TOKEN=$(echo "$ADMIN_RESPONSE" | jq -r '.access_token // empty')

          # Get organiser token for event creation
          ORGANISER_RESPONSE=$(curl -s -X POST "http://localhost:8000/auth/login" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "organiser",
              "password": "password123"
            }')

          ORGANISER_TOKEN=$(echo "$ORGANISER_RESPONSE" | jq -r '.access_token // empty')

          if [ -n "$ADMIN_TOKEN" ] && [ "$ADMIN_TOKEN" != "null" ] && [ -n "$ORGANISER_TOKEN" ] && [ "$ORGANISER_TOKEN" != "null" ]; then
            echo "‚úÖ Admin and Organiser authentication successful for event tests"
            echo "ADMIN_TOKEN=$ADMIN_TOKEN" >> $GITHUB_ENV
            echo "ORGANISER_TOKEN=$ORGANISER_TOKEN" >> $GITHUB_ENV
          else
            echo "‚ùå Authentication failed"
            echo "Admin token: $ADMIN_TOKEN"
            echo "Organiser token: $ORGANISER_TOKEN"
            exit 1
          fi

      - name: Run Comprehensive Event API Tests
        if: matrix.test-suite == 'event-mgr'
        run: |
          echo "=== Comprehensive Event API Tests ==="
          echo "Testing: Event Creation, Listing, Details, Ticket Purchase, Ticket Swapping, Authorization, Error Handling"

          # Register test users for ticket operations
          echo "Registering test users for ticket operations..."

          USER1_RESPONSE=$(curl -s -X POST "http://localhost:8000/auth/register" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "testuser1_ci",
              "email": "testuser1@ci.com",
              "password": "password123",
              "full_name": "Test User 1",
              "wallet_address": "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC",
              "private_key": "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a"
            }')

          USER1_TOKEN=$(echo "$USER1_RESPONSE" | jq -r '.access_token // empty')

          USER2_RESPONSE=$(curl -s -X POST "http://localhost:8000/auth/register" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "testuser2_ci",
              "email": "testuser2@ci.com",
              "password": "password123",
              "full_name": "Test User 2",
              "wallet_address": "0x90F79bf6EB2c4f870365E785982E1f101E93b906",
              "private_key": "0x7c852118294e51e653712a81e05800f419141751be58f605c371e15141b007a6"
            }')

          USER2_TOKEN=$(echo "$USER2_RESPONSE" | jq -r '.access_token // empty')

          if [ -n "$USER1_TOKEN" ] && [ "$USER1_TOKEN" != "null" ] && [ -n "$USER2_TOKEN" ] && [ "$USER2_TOKEN" != "null" ]; then
            echo "‚úÖ Test users registered successfully"
          else
            echo "‚ùå Test user registration failed"
            echo "User1 Response: $USER1_RESPONSE"
            echo "User2 Response: $USER2_RESPONSE"
            echo "User1 Token: $USER1_TOKEN"
            echo "User2 Token: $USER2_TOKEN"
            exit 1
          fi

          # Test 1: Create a regular event
          echo "Creating regular event with organiser..."
          CREATE_RESPONSE=$(curl -s -X POST "http://localhost:8000/events/create" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ORGANISER_TOKEN" \
            -d '{
              "name": "CI Test Concert",
              "venue": "CI Arena", 
              "date": 1733097600,
              "price": 50000000000000000,
              "total_tickets": 100
            }')

          echo "Create Event Response: $CREATE_RESPONSE"

          if echo "$CREATE_RESPONSE" | grep -q '"success":true'; then
            echo "‚úÖ Regular event creation successful"
            EVENT_ID=$(echo "$CREATE_RESPONSE" | jq -r '.event_id // 1')
          else
            echo "‚ùå Regular event creation failed"
            exit 1
          fi

          # Test 2: List all events
          echo "Listing all events..."
          LIST_RESPONSE=$(curl -s -X GET "http://localhost:8000/events/all" \
            -H "Authorization: Bearer $ORGANISER_TOKEN")

          if echo "$LIST_RESPONSE" | grep -q '\[.*\]'; then
            echo "‚úÖ Event listing successful"
          else
            echo "‚ùå Event listing failed"
            exit 1
          fi

          # Test 3: Get event details
          echo "Getting event details..."
          DETAILS_RESPONSE=$(curl -s -X GET "http://localhost:8000/events/$EVENT_ID/details" \
            -H "Authorization: Bearer $ORGANISER_TOKEN")

          if echo "$DETAILS_RESPONSE" | grep -q '"event_id"'; then
            echo "‚úÖ Event details retrieval successful"
          else
            echo "‚ùå Event details retrieval failed"
            exit 1
          fi

          # Test 4: Buy tickets for user 1
          echo "User 1 buying tickets..."
          BUY1_RESPONSE=$(curl -s -X POST "http://localhost:8000/events/buy" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $USER1_TOKEN" \
            -d "{
              \"event_id\": $EVENT_ID,
              \"quantity\": 2
            }")

          echo "User 1 Ticket Purchase: $BUY1_RESPONSE"

          if echo "$BUY1_RESPONSE" | grep -q '"success":true'; then
            echo "‚úÖ User 1 ticket purchase successful"
          else
            echo "‚ùå User 1 ticket purchase failed"
            exit 1
          fi

          # Test 5: Buy tickets for user 2
          echo "User 2 buying tickets..."
          BUY2_RESPONSE=$(curl -s -X POST "http://localhost:8000/events/buy" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $USER2_TOKEN" \
            -d "{
              \"event_id\": $EVENT_ID,
              \"quantity\": 2
            }")

          if echo "$BUY2_RESPONSE" | grep -q '"success":true'; then
            echo "‚úÖ User 2 ticket purchase successful"
          else
            echo "‚ùå User 2 ticket purchase failed"
            exit 1
          fi

          # Test 6: Ticket Swapping - User 1 approval
          echo "User 1 approving for ticket swapping..."
          APPROVE1_RESPONSE=$(curl -s -X POST "http://localhost:8000/events/tickets/swap/approve" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $USER1_TOKEN" \
            -d '{}')

          if echo "$APPROVE1_RESPONSE" | grep -q '"success":true'; then
            echo "‚úÖ User 1 swap approval successful"
          else
            echo "‚ùå User 1 swap approval failed"
            exit 1
          fi

          # Test 7: Ticket Swapping - User 2 approval
          echo "User 2 approving for ticket swapping..."
          APPROVE2_RESPONSE=$(curl -s -X POST "http://localhost:8000/events/tickets/swap/approve" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $USER2_TOKEN" \
            -d '{}')

          if echo "$APPROVE2_RESPONSE" | grep -q '"success":true'; then
            echo "‚úÖ User 2 swap approval successful"
          else
            echo "‚ùå User 2 swap approval failed"
            exit 1
          fi

          # Test 8: Check approval status
          echo "Checking User 1 approval status..."
          APPROVAL_STATUS=$(curl -s -X GET "http://localhost:8000/events/tickets/swap/approval-status" \
            -H "Authorization: Bearer $USER1_TOKEN")

          if echo "$APPROVAL_STATUS" | grep -q '"is_approved":true'; then
            echo "‚úÖ Approval status check successful"
          else
            echo "‚ùå Approval status check failed"
            exit 1
          fi

          # Test 9: Check swap eligibility (should be false for same regular event)
          echo "Checking swap eligibility between tickets from same regular event..."
          SWAP_CHECK=$(curl -s -X POST "http://localhost:8000/events/tickets/swap/check" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $USER1_TOKEN" \
            -d '{
              "ticket_id_1": 1,
              "ticket_id_2": 2
            }')

          echo "Swap Check Response: $SWAP_CHECK"

          if echo "$SWAP_CHECK" | grep -q '"can_swap": *false'; then
            echo "‚úÖ Swap eligibility check successful (correctly shows false for same regular event)"
          else
            echo "‚ùå Swap eligibility check failed - should return false for tickets from same regular event"
            exit 1
          fi

          # Test 10: Create multi-day event and test proper swapping
          echo "Testing multi-day event creation..."
          MULTIDAY_RESPONSE=$(curl -s -X POST "http://localhost:8000/events/multi-day" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ORGANISER_TOKEN" \
            -d '{
              "name": "CI Multi-Day Festival",
              "dates": [1733184000, 1733270400],
              "venues": ["Main Stage", "Electronic Stage"],
              "price": 30000000000000000,
              "tickets_per_day": [5, 5],
              "swappable_flags": [true, true]
            }')

          echo "Multi-day Response: $MULTIDAY_RESPONSE"

          # Check if multi-day event creation succeeded
          if echo "$MULTIDAY_RESPONSE" | grep -q '"success":true'; then
            echo "‚úÖ Multi-day event creation successful!"
            
            MULTIDAY_EVENT_ID=$(echo "$MULTIDAY_RESPONSE" | jq -r '.event_id // 2')
            
            # Buy tickets for different days
            echo "User 1 buying ticket for day 1..."
            BUY_DAY1_RESPONSE=$(curl -s -X POST "http://localhost:8000/events/sub-events/buy" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $USER1_TOKEN" \
              -d '{
                "sub_event_id": 1000001,
                "quantity": 1
              }')

            echo "User 2 buying ticket for day 2..."
            BUY_DAY2_RESPONSE=$(curl -s -X POST "http://localhost:8000/events/sub-events/buy" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $USER2_TOKEN" \
              -d '{
                "sub_event_id": 1000002,
                "quantity": 1
              }')

            if echo "$BUY_DAY1_RESPONSE" | grep -q '"success":true' && echo "$BUY_DAY2_RESPONSE" | grep -q '"success":true'; then
              echo "‚úÖ Multi-day tickets purchased successfully"
              
              # Test swap eligibility between different days (should be true)
              echo "Testing swap eligibility between different days..."
              MULTIDAY_SWAP_CHECK=$(curl -s -X POST "http://localhost:8000/events/tickets/swap/check" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $USER1_TOKEN" \
                -d '{
                  "ticket_id_1": 5,
                  "ticket_id_2": 6
                }')

              echo "Multi-day Swap Check: $MULTIDAY_SWAP_CHECK"

              if echo "$MULTIDAY_SWAP_CHECK" | grep -q '"can_swap": *true'; then
                echo "‚úÖ Multi-day swap eligibility check successful"
              else
                echo "‚ö†Ô∏è  Multi-day swap eligibility check returned false (may be expected)"
              fi
            else
              echo "‚ö†Ô∏è  Multi-day ticket purchases failed, skipping swap test"
            fi
            
          elif echo "$MULTIDAY_RESPONSE" | grep -q "Transaction ran out of gas"; then
            echo "‚ö†Ô∏è  Multi-day event failed with gas limit (expected behavior)"
          else
            echo "‚ùå Multi-day event creation failed unexpectedly"
            echo "Response: $MULTIDAY_RESPONSE"
          fi

          # Test 11: Error handling - Invalid event data
          echo "Testing error handling with invalid event data..."
          INVALID_RESPONSE=$(curl -s -X POST "http://localhost:8000/events/create" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ORGANISER_TOKEN" \
            -d '{
              "name": "",
              "venue": "Test Venue",
              "date": 1735689600,
              "price": -100,
              "total_tickets": 10
            }')

          if echo "$INVALID_RESPONSE" | grep -q '"detail"'; then
            echo "‚úÖ Error handling working correctly"
          else
            echo "‚ùå Error handling not working"
            exit 1
          fi

          # Test 12: Unauthorized access test
          echo "Testing unauthorized event creation..."
          UNAUTHORIZED_RESPONSE=$(curl -s -X POST "http://localhost:8000/events/create" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $USER1_TOKEN" \
            -d '{
              "name": "Unauthorized Event",
              "venue": "Test Venue",
              "date": 1735689600,
              "price": 100000000000000000,
              "total_tickets": 10
            }')

          if echo "$UNAUTHORIZED_RESPONSE" | grep -q "Access denied"; then
            echo "‚úÖ Unauthorized access properly blocked"
          else
            echo "‚ùå Unauthorized access not properly blocked"
            exit 1
          fi

          echo "=== Event API Tests Completed Successfully ==="

      - name: Setup Authentication for Resale Tests
        if: matrix.test-suite == 'resale-market'
        run: |
          echo "=== Setting up Authentication for Resale Tests ==="

          # Install jq for JSON processing
          sudo apt-get update && sudo apt-get install -y jq

          # Get admin token for event creation
          ADMIN_RESPONSE=$(curl -s -X POST "http://localhost:8000/auth/login" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "admin",
              "password": "password123"
            }')

          ADMIN_TOKEN=$(echo "$ADMIN_RESPONSE" | jq -r '.access_token // empty')

          if [ -n "$ADMIN_TOKEN" ] && [ "$ADMIN_TOKEN" != "null" ]; then
            echo "‚úÖ Admin authentication successful for resale tests"
            echo "ADMIN_TOKEN=$ADMIN_TOKEN" >> $GITHUB_ENV
          else
            echo "‚ùå Admin authentication failed"
            exit 1
          fi

      - name: Run Loyalty System Tests
        if: matrix.test-suite == 'loyalty-system'
        run: |
          echo "=== Running Comprehensive Loyalty System Integration Test ==="

          # Install dependencies for loyalty test
          sudo apt-get update && sudo apt-get install -y jq bc

          # Make the test script executable
          chmod +x ./test_loyalty_integration.sh

          # Pre-test health checks for loyalty system
          echo "=== Pre-test Health Checks ==="
          
          # Check if loyalty endpoints are responding
          HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/)
          if [ "$HEALTH_CHECK" != "200" ]; then
            echo "‚ùå API not responding (HTTP $HEALTH_CHECK)"
            exit 1
          fi
          echo "‚úÖ API health check passed"

          # Verify JWT authentication is working
          AUTH_TEST=$(curl -s -X POST "http://localhost:8000/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"username": "admin", "password": "password123"}')
          
          if echo "$AUTH_TEST" | grep -q "access_token"; then
            echo "‚úÖ JWT authentication system working"
          else
            echo "‚ùå JWT authentication failed"
            echo "Response: $AUTH_TEST"
            exit 1
          fi

          echo "Starting full loyalty system test suite..."
          echo "This test covers:"
          echo "‚Ä¢ JWT authentication for all loyalty endpoints" 
          echo "‚Ä¢ Automatic loyalty points earning on ticket purchase"
          echo "‚Ä¢ Manual loyalty points awarding via API"
          echo "‚Ä¢ Points approval system (ERC20 pattern)"
          echo "‚Ä¢ Points redemption with 30% discount cap"
          echo "‚Ä¢ Math validation and discount calculations"
          echo "‚Ä¢ Complete loyalty lifecycle end-to-end"

          # Run the comprehensive loyalty integration test
          if ./test_loyalty_integration.sh; then
            echo ""
            echo "üéâ ==================================="
            echo "üéâ LOYALTY SYSTEM TESTS PASSED!"
            echo "üéâ ==================================="
            echo "‚úÖ JWT authentication working on all endpoints"
            echo "‚úÖ Points earning (3,000 points per ETH) functional"
            echo "‚úÖ Manual points awarding via API working"
            echo "‚úÖ ERC20 approval/allowance system working"
            echo "‚úÖ Points redemption with 30% discount cap working"
            echo "‚úÖ Math validation and security checks passing"
            echo "‚úÖ Complete loyalty lifecycle end-to-end tested"
            echo "‚úÖ Oracle account authorization working"
            echo "‚úÖ All 18 test steps completed successfully"
            echo "üéâ ==================================="
          else
            echo ""
            echo "‚ùå =================================="
            echo "‚ùå LOYALTY SYSTEM TESTS FAILED"
            echo "‚ùå =================================="
            echo "Check the detailed output above for specific failure information"
            echo "Common issues to check:"
            echo "‚Ä¢ JWT token authentication failures"
            echo "‚Ä¢ Oracle account authorization issues"
            echo "‚Ä¢ Smart contract interaction problems" 
            echo "‚Ä¢ Points calculation or redemption errors"
            exit 1
          fi

          echo "=== Loyalty System CI Test Suite Completed Successfully ==="

      - name: Run Resale Market Tests
        if: matrix.test-suite == 'resale-market'
        run: |
          echo "=== Testing Resale Market (Legacy) ==="

          # Use the working marketplace test script
          chmod +x ./test_marketplace.sh
          ./test_marketplace.sh

      - name: Run Marketplace System Tests
        if: matrix.test-suite == 'marketplace-system'
        run: |
          echo "=== Testing Marketplace System ==="

          # Make test script executable and run it
          chmod +x ./test_marketplace.sh
          ./test_marketplace.sh

      - name: Run Ticket Management System Tests
        if: matrix.test-suite == 'ticket-system'
        run: |
          echo "=== Testing Ticket Management System ==="

          # Make test script executable and run it
          chmod +x ./test_ticket.sh
          ./test_ticket.sh

      - name: Check container logs on failure
        if: failure()
        run: |
          echo "=== API Container Logs ==="
          docker compose logs api

          echo "=== Blockchain Container Logs ==="
          docker compose logs blockchain

          echo "=== Postgres Container Logs ==="
          docker compose logs postgres

          echo "=== Redis Container Logs ==="
          docker compose logs redis

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up..."
          docker compose down --volumes --remove-orphans
          docker system prune -f
